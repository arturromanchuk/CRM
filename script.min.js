// https://github.com/bryanwoods/autolink-js
var g=[].slice;String.prototype.autoLink=function(){var e,t,n,r,i,s;i=1<=arguments.length?g.call(arguments,0):[];n="";r=i[0];s=/(^|\s)(\b(https?|ftp):\/\/[\-A-Z0-9+\u0026@#\/%?=~_|!:,.;]*[\-A-Z0-9+\u0026@#\/%=~_|])/gi;if(0<i.length){null!=r.callback&&"function"==typeof r.callback&&(e=r.callback,delete r.callback);for(t in r)i=r[t],n+=" "+t+"='"+i+"'";return this.replace(s,function(t,r,i){t=e&&e(i);return""+r+(t||"<a href='"+i+"'"+n+">"+i+"</a>")})}return this.replace(s,"$1<a href='$2'>$2</a>")};var crmx={config:{sitename:"",username:""},form:{},people:{},timer:!1,load:{form:function(e){"use strict";$("#form").html("");for(var t in e){if(e[t].type==="select"){e[t].html='<select id="'+e[t].name+'">';for(var n in e[t].list){e[t].html+="<option>"+e[t].list[n]+"</option>";e[t].searchable&&e[t].list[n]!=="-"&&$("#searchable").append('<li><a href="#" data-search=\'"'+e[t].name+'":"'+e[t].list[n]+"\",'>"+e[t].list[n]+"<small>"+e[t].title+"</small></a></li>")}e[t].html+="</select>"}else{e[t].type==null&&(e[t].type="text");e[t].html='<input type="'+e[t].type+'" id="'+e[t].name+'" placeholder="'+e[t].title+'">';e[t].searchable&&$("#searchable").append('<li><a href="#" data-search="'+e[t].name+'">'+e[t].name+"</a></li>")}$("#form").append('<div class="control-group"><label class="control-label" for="'+e[t].name+'">'+e[t].title+"</label>"+'<div class="controls">'+e[t].html+"</div>"+"</div>")}},people:function(e){"use strict";$("#people").html("");for(var t in e)$("#people").append('<li><a data-id="'+e[t].id+'" href="#">'+e[t].name+"<small>"+(e[t].form.title?e[t].form.title:"")+"</small></a></li>");$("#people a").on("click",function(){crmx.get($(this).data("id"));return!1})},comments:function(e){"use strict";$("#comments").html("");for(var t in e)$("#comments").append("<blockquote>"+e[t].text.autoLink()+'<small><em class="easydate">'+e[t].date+"</em> by <strong>"+e[t].user+"</strong></small></blockquote>");$(".easydate").easydate()}},refresh:function(){"use strict";$("#s").val("");crmx.search("")},save:function(){"use strict";crmx.notification("Loading&hellip;");var e={id:$("#id").val(),name:$("#name").val(),title:$("#title").val()};for(var t in crmx.form)e[crmx.form[t].name]=$("#"+crmx.form[t].name).val();$.ajax({type:"POST",url:"save",data:e}).done(function(e){crmx.notification(e.message,e.status);if(e.status==="success"){$(".save").fadeOut();$("#delete").fadeIn();$("#commentbox").fadeIn();crmx.refresh();if(e.id){$("#id").val(e.id);$("#people li a[data-id="+e.id+"]").parent().addClass("active")}}})},remove:function(e){"use strict";if(!e)return!1;if(confirm("Are you sure you want to delete this contact?")===!0){crmx.notification("Deleting&hellip;");$.ajax({type:"DELETE",url:"delete/"+e}).done(function(e){crmx.notification(e.message,e.status);if(e.status==="success"){$("#name").val("");$("#title").val("");for(var t in crmx.form)$("#"+crmx.form[t].name).val("");$(".save").fadeOut();$("#delete").fadeOut();$("#commentbox").fadeOut();crmx.search("")}else crmx.notification(e.message,e.status)})}},comment:function(e,t){"use strict";crmx.notification("Commenting&hellip;");$.ajax({type:"POST",url:"comment",data:{id:e,comment:t}}).done(function(e){if(e.status!=="error"){crmx.notification();$("#c").val("");crmx.load.comments(e)}else crmx.notification(e.message,e.status)})},get:function(e){"use strict";crmx.notification("Loading&hellip;");$.ajax({type:"GET",url:"get/"+e}).done(function(t){if(t.status!=="error"){crmx.notification();$("#name").val(t.name);$("#id").val(t.id);$("#title").val(t.form.title);for(var n in crmx.form)$("#"+crmx.form[n].name).val(t.form[crmx.form[n].name]);$(".save").fadeOut();$("#delete").fadeIn();$("#commentbox").fadeIn();$("#people li").removeClass("active");$("#people li a[data-id="+e+"]").parent().addClass("active");crmx.load.comments(t.comments)}else crmx.notification(t.message,t.status)})},search:function(e){"use strict";$("#people").prepend('<li class="nav-header">Searching&hellip;</li>');$.ajax({type:"GET",url:"search/"+e}).done(function(e){e.status?crmx.notification(e.message,e.status):crmx.load.people(e)})},notification:function(e,t){"use strict";e==null?$("#notification").fadeOut("fast"):$("#notification").html((t?"<strong>"+t+"</strong> ":"")+e).attr("class","alert alert-"+t).fadeIn(500,function(){$(this).fadeOut(1e4)}).click(function(){$(this).fadeOut(500)})},updateui:function(){"use strict";if($("#id").val().length>0){$(".save").fadeIn().html("Save");$("#delete").fadeIn()}else{$(".save").fadeIn().html("Create new");$("#delete").fadeOut()}},run:function(){"use strict";crmx.load.people(crmx.people);crmx.load.form(crmx.form);$(".save").on("click",function(){crmx.save();return!1});$("#delete").on("click",function(){crmx.remove($("#id").val());return!1});$("#form").on("change","select",function(){crmx.updateui()});$("#main").on("input paste","input",function(){crmx.updateui()});$("#name").on("input paste",function(){crmx.updateui()});$("#title").on("input paste",function(){crmx.updateui()});$("#s").on("input paste",function(){if(crmx.timer===!1){crmx.timer=!0;var e=setTimeout(function(){crmx.search($("#s").val());crmx.timer=!1},500)}});$("#c_button").on("click",function(){if($("#id").val().length<1){crmx.notification("Select a contact first","error");return!1}if($("#c").val().length<1){crmx.notification("Enter a comment first","error");return!1}crmx.comment($("#id").val(),$("#c").val().replace(/\n/g,"<br>"))});$("#searchable").click(function(e){var t=$(e.target);crmx.search(t.data("search"))});$("#s").focus()}};